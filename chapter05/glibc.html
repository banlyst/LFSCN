<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      5.7.&nbsp;Glibc-2.15
    </title>
    <link rel="stylesheet" href="../stylesheets/lfs.css" type="text/css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.73.2" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="lfs" id="lfs-SVN-20120514">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 SVN-20120514
      </h4>
      <h3>
        第&nbsp;5&nbsp;章&nbsp;搭建临时系统
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="linux-headers.html" title=
          "Linux-3.3.6 API 头文件">上一页</a>
          <p>
            Linux-3.3.6 API 头文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="binutils-pass2.html" title=
          "Binutils-2.22 - 第二遍">下一页</a>
          <p>
            Binutils-2.22 - 第二遍
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;搭建临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 SVN-20120514">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-glibc" name="ch-tools-glibc"></a>5.7. Glibc-2.15
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          The Glibc package contains the main C library. This library
          provides the basic routines for allocating memory, searching
          directories, opening and closing files, reading and writing files,
          string handling, pattern matching, arithmetic, and so on.
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">预计编制时间:</strong> <span class=
              "segbody">5.5 SBU</span>
            </div>
            <div class="seg">
              <strong class="segtitle">需求磁盘空间:</strong> <span class=
              "segbody">501 MB</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          5.7.1. 安装 Glibc
        </h2>
        <p>
          修复一个因为现在不完整的编译环境所造成的头文件检测失败：
        </p>
        <pre class="userinput">
<kbd class=
"command">sed -i 's#$ac_includes_default#\n\n#' sysdeps/i386/configure</kbd>
</pre>
        <p>
          修复一个不可更改路径：
        </p>
        <pre class="userinput">
<kbd class="command">sed -i 's#/var/db#/tools/var/db#' Makeconfig</kbd>
</pre>
        <p>
          修复一个阻止 Glibc 以 GCC-4.7.0 编制的漏洞：
        </p>
        <pre class="userinput">
<kbd class="command">patch -Np1 -i ../glibc-2.15-gcc_fix-1.patch</kbd>
</pre>
        <p>
          Glibc 文档推荐在源代码目录外另建目录编译 Glibc：
        </p>
        <pre class="userinput">
<kbd class="command">mkdir -v ../glibc-build
cd ../glibc-build</kbd>
</pre>
        <p>
          因为 Glibc 不再支持 i386，所以Glibc的开发者提出使用 <em class=
          "parameter"><code>-march=i486</code></em> 参数在 x86
          平台上进行编译。这里有几种不同的实现方法，但测试表明将这个参数加到 “<span class=
          "quote">CFLAGS</span>” 中会比较好。我们通过将这个参数加入到 <code class=
          "filename">configparms</code> 文件中来达到目的，而不是彻底覆盖 Glibc 的内部
          CFLAGS。-mtune=native 参数也很重要，当重新设定 -march 的值时，可以得到一个合理的 -mtune 的值。
        </p>
        <pre class="userinput">
<kbd class="command">case `uname -m` in
  i?86) echo "CFLAGS += -march=i486 -mtune=native" &gt; configparms ;;
esac</kbd>
</pre>
        <p>
          接下来，准备编译 Glibc：
        </p>
        <pre class="userinput">
<kbd class="command">../glibc-2.15/configure                             \
      --prefix=/tools                                 \
      --host=$LFS_TGT                                 \
      --build=$(../glibc-2.15/scripts/config.guess) \
      --disable-profile                               \
      --enable-add-ons                                \
      --enable-kernel=2.6.25                          \
      --with-headers=/tools/include                   \
      libc_cv_forced_unwind=yes                       \
      libc_cv_ctors_header=yes                        \
      libc_cv_c_cleanup=yes</kbd>
</pre>
        <div class="variablelist">
          <p class="title">
            <b>配置选项的含义：</b>
          </p>
          <dl>
            <dt>
              <span class="term"><em class="parameter"><code>--host=$LFS_TGT,
              --build=$(../glibc-2.15/scripts/config.guess)</code></em></span>
            </dt>
            <dd>
              <p>
                这几个参数告诉 Glibc 使用 <code class="filename">/tools</code>
                中的编译器和链接器进行交叉编译。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-profile</code></em></span>
            </dt>
            <dd>
              <p>
                不使用检测的信息进行编译。当需要检测信息时，去掉这个参数。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-add-ons</code></em></span>
            </dt>
            <dd>
              <p>
                告诉 Glibc 使用附加的 NPTL 作为线程库。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-kernel=2.6.25</code></em></span>
            </dt>
            <dd>
              <p>
                告诉 Glibc 提供 2.6.25 或更高的内核的支持。比这个旧的内核将不会提供支持。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-headers=/tools/include</code></em></span>
            </dt>
            <dd>
              <p>
                告诉 Glibc 使用 tools 文件夹里的头文件编译自身，这样可以让 Glibc 根据新的内核进行优化。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>libc_cv_forced_unwind=yes</code></em></span>
            </dt>
            <dd>
              <p>
                在<a class="xref" href="binutils-pass1.html" title=
                "5.4.&nbsp;Binutils-2.22 - 第一遍">第&nbsp;5.4&nbsp;节
                “Binutils-2.22 -
                第一遍”</a>安装的链接器是交叉编译得到的，在Glibc安装好之前，它不能正常工作。这意味着 configure 对
                force-unwind 的检查会失败。libc_cv_forced_unwind=yes 告诉 <span class=
                "command"><strong>configure</strong></span> 脚本不进行这项检查。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>libc_cv_c_cleanup=yes</code></em></span>
            </dt>
            <dd>
              <p>
                同样，我们传递 libc_cv_c_cleanup=yes 给 <span class=
                "command"><strong>configure</strong></span> 脚本跳过检查但仍配置 C
                清理控制支持。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>libc_cv_ctors_header=yes</code></em></span>
            </dt>
            <dd>
              <p>
                同样，我们传递 libc_cv_ctors_header=yes 给 <span class=
                "command"><strong>configure</strong></span> 脚本跳过检查但仍配置 gcc
                构造函数支持。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          在这步进行时，可能会有下面的警告：
        </p>
        <div class="blockquote">
          <blockquote class="blockquote">
            <pre class="screen">
<code class="computeroutput">configure: WARNING:
*** These auxiliary programs are missing or
*** incompatible versions: msgfmt
*** some features will be disabled.
*** Check the INSTALL file for required versions.</code>
</pre>
          </blockquote>
        </div>
        <p>
          这个丢失或不合适的 <span class="command"><strong>msgfmt</strong></span>
          程序在这里是无害的。这个 <span class="command"><strong>msgfmt</strong></span> 是
          gettext 的一部分，宿主系统应该提供这个。
        </p>
        <p>
          编译程序包：
        </p>
        <pre class="userinput">
<kbd class="command">make</kbd>
</pre>
        <p>
          此程序包包含测试套件，但现在还不能运行，因为我们还没有 C++ 编译器。
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            这些测试的成功执行同样需要正确安装的区域数据。区域数据提供系统默认的信息，比如日期、时间、货币格式以及系统工具的输出。如果在本章不运行测试套件，就没必要现在安装区域数据
            (推荐)。合适的区域数据将会在下一章安装。如果无论如何都要安装 Glibc 区域数据，参考<a class="xref"
            href="../chapter06/glibc.html" title=
            "6.9.&nbsp;Glibc-2.15">第&nbsp;6.9&nbsp;节 “Glibc-2.15”</a>。
          </p>
        </div>
        <p>
          安装程序包：
        </p>
        <pre class="userinput">
<kbd class="command">make install</kbd>
</pre>
        <div class="admon caution">
          <img alt="[小心]" src="../images/caution.png" />
          <h3>
            小心
          </h3>
          <p>
            在这里，停下来确保新工具链的基本功能 (编译和链接) 能正常工作很重要。要进行完整性检查，运行以下命令：
          </p>
          <pre class="userinput">
<kbd class="command">echo 'main(){}' &gt; dummy.c
$LFS_TGT-gcc dummy.c
readelf -l a.out | grep ': /tools'</kbd>
</pre>
          <p>
            如果一切工作正常，就不会出现错误，最后一条命令的输出会符合以下格式：
          </p>
          <pre class="screen">
<code class=
"computeroutput">[Requesting program interpreter: /tools/lib/ld-linux.so.2]</code>
</pre>
          <p>
            留意 <code class="filename">/tools/lib</code> 或者 64 位计算机上的
            <code class="filename">/tools/lib64</code> 作为动态链接器的前缀出现。
          </p>
          <p>
            如果输出不如上文所示或者根本没有输出，那就有什么地方出错了。研究回溯刚才的步骤，查出问题并修正它。在继续之前必须解决这一问题。可能在刚才的
            specs 文件修改过程中出现了问题。如果出现了这种情况，重做 specs
            文件修改，小心地复制粘贴命令。(译注：在这一版本中并没有进行 specs 文件修改，此处的解释有误，但原文如此。)
          </p>
          <p>
            一切正常之后，清理测试文件：
          </p>
          <pre class="userinput">
<kbd class="command">rm -v dummy.c a.out</kbd>
</pre>
        </div>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            下一节中编制 Binutils 相当与额外检查了一次工具链是否正常编制。如果 Binutils 编制失败，就说明之前的
            Binutils、GCC 或 Glibc 安装出现了问题。
          </p>
        </div>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <p>
          有关此程序包的细节位于<a class="xref" href=
          "../chapter06/glibc.html#contents-glibc" title=
          "6.9.4.&nbsp;Contents of Glibc">第&nbsp;6.9.4&nbsp;节 “Contents of
          Glibc”</a>。
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="linux-headers.html" title=
          "Linux-3.3.6 API 头文件">上一页</a>
          <p>
            Linux-3.3.6 API 头文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="binutils-pass2.html" title=
          "Binutils-2.22 - 第二遍">下一页</a>
          <p>
            Binutils-2.22 - 第二遍
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;搭建临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 SVN-20120514">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
